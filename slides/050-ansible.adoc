== Ansible

[.notes]
****

Outil d'automatisation permettant provisionnement machines

Peut déployer sur parc de machine distant ou une seule machine locale

roles/playbooks

Notion communauté +++ qui va permettre de faire assemblage de roles pour répondre au besoin ou création roles et publication

Syntaxe YAML
****

=== How to use it ?

image::tell_me_more.gif[alt='Tell me more',width=80%]

=== Structure

[%linenums,text]
----
├── playbooks
│   ├── demo
│   ├── work
│   ├── ├── main.yaml
├── roles
│   ├── jetbrains_toolbox
│   │   ├── defaults
│   │   ├── tasks
│   │── git_config
│   │   ├── tasks
│   └── [...]
----

=== Playbook

[%linenums,yaml]
----
- hosts: localhost
  tasks:
    - name: "Simple task"
      debug:
        msg: |-
include::../code/public_data.txt[]
  roles:
    - role: geerlingguy.docker
      become: true
    - role: git_config
----

[.notes]
****
task / role communauté / role custom
****

=== Usage

[%linenums,bash,highlight=1-3|4-5|6-9]
----
$ cat scripts/setup.sh
python3 -m pip install --user -r "requirements.txt"
ansible-galaxy role install -r "requirements.yml"
$ cat requirements.txt
ansible==7.0.0
$ cat requirements.yml
roles:
  - src: geerlingguy.docker
    version: 6.1.0
----

=== Usage

[%linenums,bash]
----
$ ansible-playbook playbooks/demo/main.yaml -K
BECOME password:
----

[%linenums,text]
----
PLAY [localhost] ************************************

TASK [git_config : Ensure Git config file exists] ************************************
ok: [localhost]

TASK [git_config : Render Git config Template] ************************************
changed: [localhost]

PLAY RECAP ************************************
localhost                  : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

Playbook run took 0 days, 0 hours, 0 minutes, 1 seconds
----

[.notes]
****
!!!! idempotent !!!!!!
OK vs changed
****

=== Software installation

[%linenums,yaml]
.roles/commons/defaults/main.yaml
----
packages_to_install:
  - vim
  - firefox
  - code
----

[%linenums,yaml]
.roles/commons/tasks/main.yaml
----
- name: Install packages
  become: true
  ansible.builtin.package:
    name: "{{ packages_to_install }}"
    state: present
----

[%linenums,yaml]
.playbooks/demo/main.yaml
----
- hosts: localhost
  roles:
    - role: commons
      vars:
        packages_to_install: [vim]
----

=== Symlink

[%linenums,text]
----
roles/symlink
├── files
│   ├── .config
│   │   ├── htop
│   │   │   └── htoprc
│   └── .vimrc
----

[%linenums,yaml,highlight=7-11]
.roles/symlink/tasks/main.yaml
----
---

# item = .vimrc
# [...] Create folders
# [...] Ensure file does not exists

- name: "{{ item }} : Update dotfile symlink"
  file:
    src: "{{ role_path }}/files/{{ item }}"
    dest: ~/{{ item }}
    state: link
----

[.notes]
****
Réplique comportement stow
****

=== Templating

[%linenums,yaml]
----
- name: Template gitconfig
  ansible.builtin.template:
    src: templates/gitconfig.j2
    dest: "~/.gitconfig"
----

[%linenums,ini]
.roles/git_config/templates/gitconfig.j2
----
[user]
{% if git_config_user is defined %}
  name = {{ git_config_user }}
{% endif %}
{% if git_config_email is defined %}
  email = {{ git_config_email }}
{% endif %}
----

<https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_templating.html>

[.notes]
****
- variabiliser
- ansible utilise jinja2 comme moteur de template
- Dire que possible si besoin de boucles à partir de variables, mais ne pas présenter et renvoyer vers la documentation
****

=== Secrets

[%linenums,yaml]
----
- name: "Copy secret file"
  copy:
    src: "secret_data.txt"
    dest: ~/secret_data.txt
    mode: "0600"
----

[.notes]
****
ansible transparent sur usage vault, va utiliser password indiqué.
Possible de le préciser dans un fichier pour éviter d'avoir à le retaper à chaque fois.
****

=== Secrets

[%linenums,bash]
----
include::../code/secret_data.txt[]
----

[.notes]
****
speaker: ansible transparent sur usage vault, va utiliser password indiqué.
Possible de le préciser dans un fichier pour éviter d'avoir à le retaper à chaque fois.
****

=== Secrets

[%linenums,shell,highlight=1|2-4|5]
----
ansible-vault create secret_data.txt
$ ansible-vault view secret_data.txt
Vault password:
include::../code/public_data.txt[]
$ ansible-playbook playbooks/demo/main.yaml --ask-vault-pass
----

[.notes]
****
ansible transparent sur usage vault, va utiliser password indiqué.
Possible de le préciser dans un fichier pour éviter d'avoir à le retaper à chaque fois.

mot de passe =
include::../code/password_file[]
****

=== Many workstation ?

[%linenums,text]
----
├── demo
│   ├── main.yaml
└── work
    └── main.yaml
----

=== What else ?

image::battery_off.png[alt='Indicateur batterie off']

[.fragment]
--
[%linenums,yaml]
----
- name: Display battery percentage
  dconf:
    key: "/org/gnome/desktop/interface/show-battery-percentage"
    value: "true"
    state: present
----

image::battery_on.png[alt='Indicateur batterie on']

Windows (regedit) : link:https://docs.ansible.com/ansible/latest/collections/ansible/windows/win_regedit_module.html[win_regedit_module]
--

=== Demo

video::demo.mp4[width=1200,opts="autoplay,loop,muted"]

=== Pros and Cons

[%autowidth.stretch,cols="1,1"]
|===
|Goal | State
|Manage my configuration files
|✅
|Manage my installed software
|✅
|Version Control
|✅
|Maintainability
|✅
|Manage personal and pro workstation
|✅
|Can handle secrets
|✅
|===

[.notes]
****
- Peu de prérequis
- Vous utilisez déjà ansible pour votre configuration de machines ?
- Roles / Playbooks (séparer PC pro/perso)
- Syntaxe YAML

Cependant, si pas d'usage d'ansible autre que pour un seul poste, peu être "lourd" à mettre en place

****

=== What if...

https://docs.ansible.com/

https://galaxy.ansible.com/
